
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QConnectionLibrary.serialclient.serial_base &#8212; The QConnection Base Library  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for QConnectionLibrary.serialclient.serial_base</h1><div class="highlight"><pre>
<span></span><span class="c1"># *******************************************************************************</span>
<span class="c1">#</span>
<span class="c1"># File: serial_base.py</span>
<span class="c1">#</span>
<span class="c1"># Initially created by Cuong Nguyen (RBVH/ECM11) / May 2021.</span>
<span class="c1"># Based on lib/TCP/Serial/CSerialClient.py in TML Framework.</span>
<span class="c1">#</span>
<span class="c1"># Description:</span>
<span class="c1">#   Provide the class for handling SSH connection.</span>
<span class="c1">#</span>
<span class="c1"># History:</span>
<span class="c1">#</span>
<span class="c1"># 12.05.2021 / V 0.1 / Cuong Nguyen</span>
<span class="c1"># - Initialize</span>
<span class="c1">#</span>
<span class="c1"># *******************************************************************************</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">QConnectionLibrary.connection_base</span> <span class="kn">import</span> <span class="n">ConnectionBase</span><span class="p">,</span> <span class="n">BrokenConnError</span>
<span class="kn">from</span> <span class="nn">QConnectionLibrary.utils</span> <span class="kn">import</span> <span class="n">DictToClass</span>
<span class="kn">from</span> <span class="nn">robot.libraries.BuiltIn</span> <span class="kn">import</span> <span class="n">BuiltIn</span>
<span class="kn">import</span> <span class="nn">QConnectionLibrary.constants</span> <span class="k">as</span> <span class="nn">constants</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">currentframe</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">queue</span>


<div class="viewcode-block" id="SerialConfig"><a class="viewcode-back" href="../../../QConnectionLibrary.html#QConnectionLibrary.serialclient.serial_base.SerialConfig">[docs]</a><span class="k">class</span> <span class="nc">SerialConfig</span><span class="p">(</span><span class="n">DictToClass</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class to store the configuration for Serial connection.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;COM1&#39;</span>
   <span class="n">baudrate</span> <span class="o">=</span> <span class="mi">115200</span>
   <span class="n">bytesize</span> <span class="o">=</span> <span class="mi">8</span>
   <span class="n">stopbits</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">STOPBITS_ONE</span>
   <span class="n">parity</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">PARITY_NONE</span>
   <span class="n">rtscts</span> <span class="o">=</span> <span class="kc">False</span>
   <span class="n">xonxoff</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SerialSocket"><a class="viewcode-back" href="../../../QConnectionLibrary.html#QConnectionLibrary.serialclient.serial_base.SerialSocket">[docs]</a><span class="k">class</span> <span class="nc">SerialSocket</span><span class="p">(</span><span class="n">ConnectionBase</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class for handling serial connection.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">_CONNECTION_TYPE</span> <span class="o">=</span> <span class="s2">&quot;SERLL-&quot;</span>
   <span class="n">_socket_instance</span> <span class="o">=</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_mode</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Constructor for SerialSocket class.</span>
<span class="sd">      </span>
<span class="sd">      Args:</span>
<span class="sd">         _mode: unused.</span>
<span class="sd">         config: Configurations for Serial connection.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">SerialConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
      <span class="n">ConnectionBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">port</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_baudrate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">baudrate</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_bytesize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">bytesize</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_stopbits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stopbits</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parity</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rtscts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rtscts</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_xonxoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">xonxoff</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># protected: None is required to run in blocking mode.</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_send_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_read_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

      <span class="n">SerialSocket</span><span class="o">.</span><span class="n">_socket_instance</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="kc">False</span>

      <span class="c1"># initialize receiver thread</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_init_thread_receiver</span><span class="p">(</span><span class="n">SerialSocket</span><span class="o">.</span><span class="n">_socket_instance</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;SER-&quot;</span><span class="p">)</span>


      <span class="c1"># configure and initialize the lowlevel receiver thread</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>  <span class="c1"># initialize the lowlevel receiver thread</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_init_thrd_llrecv</span><span class="p">(</span><span class="n">SerialSocket</span><span class="o">.</span><span class="n">_socket_instance</span><span class="p">)</span>
      <span class="c1"># create the queue for this connection</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">serial_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">_thrd_llrecv_from_connection_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Receive and process data from serial connection in low-level.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">_mident</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: lowlevel receiver thread started.&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>
      <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ConnectionBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>

      <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
         <span class="c1"># noinspection PyBroadException</span>
         <span class="c1"># implementation from here:</span>
         <span class="c1"># http://sourceforge.net/p/pyserial/code/HEAD/tree/trunk/pyserial/examples/rfc2217_server.py</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>  <span class="c1"># read one, blocking</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">in_waiting</span>  <span class="c1"># look if there is more</span>
            <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
               <span class="n">read_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
               <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">read_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>  <span class="c1"># and get as much as possible</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
               <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">serial_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">character</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_reason</span><span class="p">:</span>
            <span class="c1"># ignore all errors.</span>
            <span class="k">pass</span>

         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ConnectionBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>

      <span class="c1"># _read must have chance to terminate, too,therefore</span>
      <span class="c1"># wait here 5 times polling interval</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ConnectionBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: lowlevel receiver thread terminated.&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>

<div class="viewcode-block" id="SerialSocket.connect"><a class="viewcode-back" href="../../../QConnectionLibrary.html#QConnectionLibrary.serialclient.serial_base.SerialSocket.connect">[docs]</a>   <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Connect to serial port.</span>

<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">pass</span></div>

<div class="viewcode-block" id="SerialSocket.disconnect"><a class="viewcode-back" href="../../../QConnectionLibrary.html#QConnectionLibrary.serialclient.serial_base.SerialSocket.disconnect">[docs]</a>   <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_device</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Disconnect serial port.</span>
<span class="sd">      </span>
<span class="sd">      Args:</span>
<span class="sd">         _device: unused.</span>

<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="kc">False</span></div>


   <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">_cr</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send data to serial port.</span>
<span class="sd">      </span>
<span class="sd">      Args:</span>
<span class="sd">         msg: Message to be sent.</span>
<span class="sd">         _cr: Unused.</span>

<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">_mident</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
         <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: sending: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_mident</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_DEBUG</span><span class="p">)</span>
         <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_lock</span><span class="p">:</span>
            <span class="n">send_byte</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rm_q_dollar</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">send_byte</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">reason</span><span class="p">:</span>
         <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: could not send: &#39;</span><span class="si">%s</span><span class="s2">&#39;. Reason: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_mident</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">reason</span><span class="p">)),</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_WARNING</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="kc">False</span>


   <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Receive data from serial connection.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         Data received from connection.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
      <span class="c1">#  usually \r\n or \n is sent to terminate a line,</span>
      <span class="c1">#  but U-Boot sends \n\r, therefore try to fit to all</span>
      <span class="c1">#  possible line endings and return the identified line.</span>

      <span class="c1"># We read the data here from the queue filled by the</span>
      <span class="c1"># low-level receiver thread.</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">d</span>
         <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># non blocking get from serq causes that</span>
            <span class="c1"># Queue.Empty exception. In this case wait some milliseconds before</span>
            <span class="c1"># retry</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ConnectionBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>

      <span class="c1"># remove the \n</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

      <span class="c1"># if we filter for \n, then</span>
      <span class="c1"># if a \r\n was sent, we need to remove the remaining \r</span>
      <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span>
         <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="c1"># if \n\r was sent, then the next line starts with a \r which</span>
      <span class="c1"># need to be removed.</span>
      <span class="c1"># Disadvantage: If somebody uses \r to overwrite an existing line,</span>
      <span class="c1"># this will not work because the in this case intended \r will be filtered,</span>
      <span class="c1"># too.</span>
      <span class="k">if</span> <span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span>
         <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

      <span class="c1">#   SerialSocket decodes all characters from UTF-8 to unicode with mode &quot;replace&quot;.</span>
      <span class="c1">#   This avoids that data waste caused e.g. by startup/shutdown of the target can bring corrupt data into</span>
      <span class="c1">#   the TML Framework.</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_dollar</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<div class="viewcode-block" id="SerialSocket.quit"><a class="viewcode-back" href="../../../QConnectionLibrary.html#QConnectionLibrary.serialclient.serial_base.SerialSocket.quit">[docs]</a>   <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Quit serial connection.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         None</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
         <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ConnectionBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span> <span class="o">=</span> <span class="kc">None</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_thrd_obj</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_thrd_obj</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_recv_thrd_term</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
         <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_thrd_obj</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">ConnectionBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_recv_thrd_obj</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">SerialSocket</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></div></div>



<div class="viewcode-block" id="SerialClient"><a class="viewcode-back" href="../../../QConnectionLibrary.html#QConnectionLibrary.serialclient.serial_base.SerialClient">[docs]</a><span class="k">class</span> <span class="nc">SerialClient</span><span class="p">(</span><span class="n">SerialSocket</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Serial client class.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">_CONNECTION_TYPE</span> <span class="o">=</span> <span class="s2">&quot;SerialClient&quot;</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_mode</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Constructor for SerialClient class.</span>
<span class="sd">      </span>
<span class="sd">      Args:</span>
<span class="sd">         _mode: unused.</span>
<span class="sd">         config: Dictionary contains the configurations for serial connection.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">SerialClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_mode</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

<div class="viewcode-block" id="SerialClient.connect"><a class="viewcode-back" href="../../../QConnectionLibrary.html#QConnectionLibrary.serialclient.serial_base.SerialClient.connect">[docs]</a>   <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Connect to the Serial port.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">_mident</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>

      <span class="k">try</span><span class="p">:</span>
         <span class="c1"># ports are counted from 0, therefore it is self._port-1</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span>
                                     <span class="n">baudrate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baudrate</span><span class="p">,</span>
                                     <span class="n">bytesize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bytesize</span><span class="p">,</span>
                                     <span class="n">stopbits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stopbits</span><span class="p">,</span>
                                     <span class="n">parity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parity</span><span class="p">,</span>
                                     <span class="n">rtscts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rtscts</span><span class="p">,</span>
                                     <span class="n">xonxoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_xonxoff</span><span class="p">,</span>
                                     <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">reason</span><span class="p">:</span>
         <span class="c1"># BuiltIn().log(&quot;%s: %s&quot; % (_mident, reason), constants.LOG_LEVEL_ERROR)</span>
         <span class="k">raise</span> <span class="n">BrokenConnError</span><span class="p">(</span><span class="s2">&quot;Not possible to connect. Reason: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">reason</span><span class="p">)))</span>

      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: connected to COM</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">) rtscts=</span><span class="si">%s</span><span class="s2"> xonxoff=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_mident</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_baudrate</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_bytesize</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_parity</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_stopbits</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_rtscts</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_xonxoff</span><span class="p">),</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span></div></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">The QConnection Base Library</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../QConnectionLibrary.html">QConnectionLibrary package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Nguyen Huynh Tri Cuong (RBVH/ECM1).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>