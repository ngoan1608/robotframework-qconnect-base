
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QConnectBase.tcp.ssh.ssh_client &#8212; The QConnection Base Library  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for QConnectBase.tcp.ssh.ssh_client</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright 2020-2022 Robert Bosch Car Multimedia GmbH</span>
<span class="c1">#</span>
<span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>
<span class="c1"># *******************************************************************************</span>
<span class="c1">#</span>
<span class="c1"># File: ssh_client.py</span>
<span class="c1">#</span>
<span class="c1"># Initially created by Cuong Nguyen (RBVH/ECM11) / May 2021.</span>
<span class="c1"># Based on lib/TCP/SSH/CSSHClient.py in TML Framework.</span>
<span class="c1">#</span>
<span class="c1"># Description:</span>
<span class="c1">#   Provide the class for handling SSH connection.</span>
<span class="c1">#</span>
<span class="c1"># History:</span>
<span class="c1">#</span>
<span class="c1"># 12.05.2021 / V 0.1 / Cuong Nguyen</span>
<span class="c1"># - Initialize</span>
<span class="c1">#</span>
<span class="c1"># *******************************************************************************</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">robot.libraries.BuiltIn</span> <span class="kn">import</span> <span class="n">BuiltIn</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">currentframe</span>
<span class="kn">import</span> <span class="nn">QConnectBase.constants</span> <span class="k">as</span> <span class="nn">constants</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">from</span> <span class="nn">QConnectBase.tcp.tcp_base</span> <span class="kn">import</span> <span class="n">BrokenConnError</span><span class="p">,</span> <span class="n">TCPBaseClient</span><span class="p">,</span> <span class="n">TCPBase</span><span class="p">,</span> <span class="n">TCPConfig</span>


<div class="viewcode-block" id="AuthenticationType"><a class="viewcode-back" href="../../../../QConnectBase.html#QConnectBase.tcp.ssh.ssh_client.AuthenticationType">[docs]</a><span class="k">class</span> <span class="nc">AuthenticationType</span><span class="p">:</span>
   <span class="n">KEYFILE</span> <span class="o">=</span> <span class="s1">&#39;keyfile&#39;</span>
   <span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;password&#39;</span>
   <span class="n">PASSWORDKEYFILE</span> <span class="o">=</span> <span class="s1">&#39;passwordkeyfile&#39;</span></div>


<div class="viewcode-block" id="SSHConfig"><a class="viewcode-back" href="../../../../QConnectBase.html#QConnectBase.tcp.ssh.ssh_client.SSHConfig">[docs]</a><span class="k">class</span> <span class="nc">SSHConfig</span><span class="p">(</span><span class="n">TCPConfig</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class to store the configuration for SSH connection.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
   <span class="n">port</span> <span class="o">=</span> <span class="mi">22</span>
   <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
   <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
   <span class="n">authentication</span> <span class="o">=</span> <span class="s1">&#39;password&#39;</span>
   <span class="n">key_filename</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SSHClient"><a class="viewcode-back" href="../../../../QConnectBase.html#QConnectBase.tcp.ssh.ssh_client.SSHClient">[docs]</a><span class="k">class</span> <span class="nc">SSHClient</span><span class="p">(</span><span class="n">TCPBase</span><span class="p">,</span> <span class="n">TCPBaseClient</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   SSH client connection class.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">_CONNECTION_TYPE</span> <span class="o">=</span> <span class="s2">&quot;SSHClient&quot;</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_mode</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Constructor for SSHClient class.</span>
<span class="sd">      </span>
<span class="sd">      Args:</span>
<span class="sd">         _mode: unused.</span>
<span class="sd">         config: configurations for SSH Client.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># paramiko.SSHClient.__init__(self)</span>
      <span class="c1"># CVirtualSocket.__init__(self, address, port)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">SSHConfig</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
      <span class="n">config_tcp</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
         <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
         <span class="s1">&#39;logfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logfile</span>
      <span class="p">}</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">username</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">password</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">key_filename</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_authentication</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">authentication</span>

      <span class="c1"># create the queue for this connection</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">SSHq</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

      <span class="c1"># configure and initialize the low-level receiver thread</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">SSHClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_mode</span><span class="p">,</span> <span class="n">config_tcp</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_init_thrd_llrecv</span><span class="p">(</span><span class="n">TCPBase</span><span class="o">.</span><span class="n">_socket_instance</span><span class="p">)</span>


   <span class="k">def</span> <span class="nf">_thrd_llrecv_from_connection_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implementation the thread for getting data from ssh connection.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">_mident</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: low-level receiver thread started.&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>
      <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TCPBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>

      <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
         <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
         <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">recv_ready</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
               <span class="c1"># data = data + self.chan.recv(1)</span>
               <span class="n">recv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">recv</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">SSHq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">character</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">closed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
               <span class="k">break</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TCPBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>

      <span class="c1"># _read must have chance to terminate, too,therefore</span>
      <span class="c1"># wait here 5 times polling interval</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TCPBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: lowlevel receiver thread terminated.&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>


<div class="viewcode-block" id="SSHClient.connect"><a class="viewcode-back" href="../../../../QConnectBase.html#QConnectBase.tcp.ssh.ssh_client.SSHClient.connect">[docs]</a>   <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Implementation for creating a SSH connection.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">_mident</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
      <span class="n">TCPBaseClient</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

      <span class="c1"># for debugging</span>
      <span class="c1"># paramiko.common.logging.basicConfig(level=paramiko.common.DEBUG)</span>
      <span class="c1"># Connects to the SSH service (address, port)</span>
      <span class="c1"># The socket is created by CVirtualClient.connect</span>
      <span class="c1"># If authentication mode is &#39;publickey&#39;, the list of key files is used. If the key files are encrypted with a pass phrase, password is used as the pass phrase</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: starting SSHClient...&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: setting SSH policy...&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>

      <span class="c1"># To reset the flag set by CVirtualClient.connect</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authentication</span> <span class="o">==</span> <span class="n">AuthenticationType</span><span class="o">.</span><span class="n">KEYFILE</span><span class="p">:</span>
            <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: trying to establish keyfile based SSH connection...&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="n">key_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_filename</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">allow_agent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
         <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authentication</span> <span class="o">==</span> <span class="n">AuthenticationType</span><span class="o">.</span><span class="n">PASSWORD</span><span class="p">:</span>
            <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: trying to establish password based SSH connection...&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">allow_agent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
         <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authentication</span> <span class="o">==</span> <span class="n">AuthenticationType</span><span class="o">.</span><span class="n">PASSWORDKEYFILE</span><span class="p">:</span>
            <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: trying to establish password and keyfile based SSH connection...&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>

            <span class="c1"># From http://docs.paramiko.org/en/1.13/api/client.html</span>
            <span class="c1"># Authentication is attempted in the following order of priority:</span>
            <span class="c1"># 1. The pkey or key_filename passed in (if any)</span>
            <span class="c1"># 2. Any key we can find through an SSH agent</span>
            <span class="c1"># 3. Any &quot;id_rsa&quot; or &quot;id_dsa&quot; key discoverable in ~/.ssh/</span>
            <span class="c1"># 4. Plain username/password auth, if a password was given</span>
            <span class="c1">#</span>
            <span class="c1"># If a private key requires a password to unlock it, and a password is passed in,</span>
            <span class="c1"># that password will be used to attempt to unlock the key.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">,</span> <span class="n">key_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_filename</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
                                <span class="n">allow_agent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>  <span class="c1"># other authentication</span>
            <span class="k">raise</span> <span class="n">BrokenConnError</span><span class="p">(</span><span class="s2">&quot;Authentication &#39;</span><span class="si">%s</span><span class="s2">&#39; is not supported.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authentication</span><span class="p">)</span>

         <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: successfully established SSH connection on existing TCPIP socket.&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="kc">True</span>

      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">reason</span><span class="p">:</span>
         <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_mident</span><span class="p">,</span> <span class="n">reason</span><span class="p">),</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_ERROR</span><span class="p">)</span>
         <span class="k">raise</span> <span class="n">BrokenConnError</span><span class="p">(</span><span class="s2">&quot;Not possible to connect. Reason: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">reason</span><span class="p">)</span>

      <span class="c1"># per default a SSH connection is only usesd for one command, then</span>
      <span class="c1"># it will be reset.</span>
      <span class="c1"># for TML we need a permanent session that we can do e.g.</span>
      <span class="c1"># cd /to/somewhere</span>
      <span class="c1"># and then the next command will start in /to/somewhere.</span>
      <span class="c1"># Therefore we need to open a shell.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">invoke_shell</span><span class="p">()</span>
      <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: successfully invoked SSH shell for secure communication.&quot;</span> <span class="o">%</span> <span class="n">_mident</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>

      <span class="c1"># switch echo off for this terminal</span>
      <span class="c1"># echo disturbs when the command contains part of the exepcted reponse, then regexp filtering will</span>
      <span class="c1"># fetch the command instead of the response.</span>
      <span class="c1"># Therefore remove echo of the terminal.</span>
      <span class="c1"># Sporadically still echo was active. Repeating the command stopped this behaviour.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;stty -echo</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;stty -echo</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;stty -echo</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;echo Echo Is Deactivated Now</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="c1"># give echo deactivation a little time</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span></div>


   <span class="k">def</span> <span class="nf">_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">_cr</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Send message to SSH connection.</span>
<span class="sd">      </span>
<span class="sd">      Args:</span>
<span class="sd">         msg: Message to be sent.</span>
<span class="sd">         _cr: Unused.</span>

<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># noinspection PyBroadException</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">_mident</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
         <span class="n">BuiltIn</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: sending: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_mident</span><span class="p">,</span> <span class="n">msg</span><span class="p">),</span> <span class="n">constants</span><span class="o">.</span><span class="n">LOG_LEVEL_DEBUG</span><span class="p">)</span>
         <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rm_q_dollar</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_reason</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Read data from SSH connection.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         Data from SSH connection.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

      <span class="c1"># We read the data here from the queue filled by the</span>
      <span class="c1"># low-level receiver thread.</span>
      <span class="k">while</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSHq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">:</span>
               <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">d</span>
         <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># non blocking get from SSHq causes that</span>
            <span class="c1"># Queue.Empty exception. In this case wait some milliseconds before</span>
            <span class="c1"># retry</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TCPBase</span><span class="o">.</span><span class="n">RECV_MSGS_POLLING_INTERVAL</span><span class="p">)</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_dollar</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="SSHClient.close"><a class="viewcode-back" href="../../../../QConnectBase.html#QConnectBase.tcp.ssh.ssh_client.SSHClient.close">[docs]</a>   <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Close SSH connection.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># shutdown SSHClient</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">chan</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

      <span class="c1"># Execute parents close()</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">SSHClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SSHClient.quit"><a class="viewcode-back" href="../../../../QConnectBase.html#QConnectBase.tcp.ssh.ssh_client.SSHClient.quit">[docs]</a>   <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Quit and stop receiver thread.</span>
<span class="sd">      </span>
<span class="sd">      Returns:</span>
<span class="sd">         None.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># Execute parents Quit() first</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">SSHClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

      <span class="c1"># stop the low-level receiver thread</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_term</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_llrecv_thrd_obj</span> <span class="o">=</span> <span class="kc">None</span></div></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="c1"># address = &quot;172.17.0.11&quot;</span>
   <span class="c1"># sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
   <span class="c1"># sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span>
   <span class="c1"># sock.connect((address, 22))</span>
   <span class="c1"># client = paramiko.SSHClient()</span>
   <span class="c1"># client.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span>
   <span class="c1"># try:</span>
   <span class="c1">#    client.connect(sock=sock, hostname=address, username=&#39;root&#39;, password=&#39;&#39;, timeout=30.0, allow_agent=False)</span>
   <span class="c1">#    chan = client.invoke_shell()</span>
   <span class="c1">#    chan.send(&quot;ls&quot;)</span>
   <span class="c1">#    a = chan.recv(9999)</span>
   <span class="c1">#    a = chan.recv(9999)</span>
   <span class="c1">#    print(a)</span>
   <span class="c1"># except Exception as ex:</span>
   <span class="c1">#    print(ex)</span>
   <span class="n">_DEFAULT_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="s1">&#39;172.17.0.11&#39;</span><span class="p">,</span>
      <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
      <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
      <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;authentication&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
      <span class="s1">&#39;key_filename&#39;</span><span class="p">:</span> <span class="kc">None</span>
   <span class="p">}</span>
   <span class="c1"># a = SSHConfig(**_DEFAULT_CONFIG)</span>
   <span class="c1"># print(a)</span>
   <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">_DEFAULT_CONFIG</span><span class="p">)</span>
   <span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
   <span class="n">ssh</span><span class="o">.</span><span class="n">send_obj</span><span class="p">(</span><span class="s2">&quot;cd ..&quot;</span><span class="p">)</span>
   <span class="n">ssh</span><span class="o">.</span><span class="n">send_obj</span><span class="p">(</span><span class="s2">&quot;ls&quot;</span><span class="p">)</span>
   <span class="n">a</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">read_obj</span><span class="p">()</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">The QConnection Base Library</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../QConnectBase.html">QConnectBase package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Nguyen Huynh Tri Cuong (RBVH/ECM1).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>